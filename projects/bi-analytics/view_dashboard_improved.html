{% extends "base.html" %}

{% block title %}{{ dashboard.name }} - Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i data-feather="bar-chart-2"></i> {{ dashboard.name }}
        <small class="text-muted">{{ dashboard.product_type.replace('_', ' ').title() }}</small>
    </h2>
    <div>
        {% if dashboard.is_default %}
            <span class="badge bg-primary me-2">Dashboard Padrão</span>
        {% endif %}
        <a href="{{ url_for('client.dashboard') }}" class="btn btn-secondary">
            <i data-feather="arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Date Range Selector -->
<div class="card mb-4">
    <div class="card-body">
        <form id="dateRangeForm" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="startDate" class="form-label">Data Início</label>
                <input type="date" class="form-control" id="startDate" name="start_date" 
                       value="{{ (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-3">
                <label for="endDate" class="form-label">Data Fim</label>
                <input type="date" class="form-control" id="endDate" name="end_date" 
                       value="{{ datetime.now().strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-3">
                <label for="timezone" class="form-label">Fuso Horário</label>
                <select class="form-select" id="timezone" disabled>
                    <option value="GMT-3" selected>Brasil (GMT-3)</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary w-100" onclick="refreshDashboard()">
                    <i data-feather="refresh-cw"></i> Atualizar Período
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Dashboard Metrics -->
{% if metrics_data %}
    <div class="row">
        {% for metric_name, metric_points in metrics_data.items() %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">{{ get_metric_display_name(metric_name) }}</h6>
                        <small class="text-muted">{{ get_metric_description(metric_name, dashboard.product_type) }}</small>
                    </div>
                    <div class="card-body">
                        <!-- Current Value with Units -->
                        <div class="text-center mb-3">
                            <h3 class="text-primary mb-1">
                                {% if metric_points %}
                                    {{ format_metric_value(metric_points[0].value or 0, metric_name) }}
                                {% else %}
                                    0
                                {% endif %}
                            </h3>
                            <small class="text-muted">{{ get_metric_unit(metric_name) }}</small>
                        </div>
                        
                        <!-- Chart with proper data -->
                        <div style="height: 180px; position: relative; max-height: 180px;">
                            <canvas id="chart-{{ loop.index }}" style="height: 180px !important; max-height: 180px;"></canvas>
                        </div>
                        
                        <!-- Breakdown Details -->
                        {% if metric_points and metric_points[0].data %}
                            <div class="mt-3">
                                {% set data = metric_points[0].data %}
                                {% if metric_name in ['chats_by_department', 'chats_by_operator'] %}
                                    <h6>Detalhamento:</h6>
                                    <div class="small">
                                        {% for key, value in data.items() %}
                                            {% if key not in ['period', 'unit', 'daily_breakdown'] %}
                                                <div class="d-flex justify-content-between">
                                                    <span>{{ key }}:</span>
                                                    <strong>{{ value }}</strong>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'satisfaction_scores' %}
                                    <h6>Distribuição de Notas:</h6>
                                    <div class="small mb-2">
                                        {% for score, count in data.get('breakdown', {}).items() %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ score }} estrelas:</span>
                                                <strong>{{ count }}</strong>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#satisfactionModal">
                                        <i data-feather="eye"></i> Ver Pesquisas Recentes
                                    </button>
                                {% elif metric_name == 'average_response_time' %}
                                    <h6>Distribuição por Tempo:</h6>
                                    <div class="small">
                                        {% for range_key, count in data.get('breakdown', {}).items() %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ range_key }}:</span>
                                                <strong>{{ count }}</strong>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'queue_time' %}
                                    <h6>Por Horário:</h6>
                                    <div class="small">
                                        {% for hour, time in data.get('hourly_breakdown', {}).items() %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ hour }}:</span>
                                                <strong>{{ "%.1f"|format(time/60) }}min</strong>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'total_chats' %}
                                    <h6>Por Dia:</h6>
                                    <div class="small">
                                        {% for day, count in data.get('daily_breakdown', {}).items() %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ day }}:</span>
                                                <strong>{{ count }}</strong>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'tickets_by_type' %}
                                    <h6>Top 5 Tipos:</h6>
                                    <div class="small">
                                        {% for tipo, count in data.items() | list %}
                                            {% if loop.index <= 5 %}
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-truncate" style="max-width: 150px;" title="{{ tipo }}">{{ tipo }}</span>
                                                    <strong>{{ count }}</strong>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'tickets_by_group' %}
                                    <h6>Top 5 Grupos:</h6>
                                    <div class="small">
                                        {% for grupo, count in data.items() | list %}
                                            {% if loop.index <= 5 %}
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-truncate" style="max-width: 150px;" title="{{ grupo }}">{{ grupo }}</span>
                                                    <strong>{{ count }}</strong>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'ticket_states' %}
                                    <h6>Estados:</h6>
                                    <div class="small">
                                        {% for estado, count in data.items() %}
                                            <div class="d-flex justify-content-between">
                                                <span>{{ estado.replace('TicketState', '') }}</span>
                                                <strong>{{ count }}</strong>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif metric_name == 'average_resolution_time' %}
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#resolutionTimeModal">
                                        <i data-feather="clock" class="me-1"></i>Ver Detalhes
                                    </button>
                                {% elif metric_name == 'available_cross_fields' %}
                                    <div class="alert alert-info mb-2 p-2">
                                        <small><strong>Cross-Filtering Disponível</strong><br>
                                        Administradores podem configurar em /admin/cross-filters</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#formFieldsModal">
                                        <i data-feather="list" class="me-1"></i>Ver Campos ({{ metric_points[0].metric_value }})
                                    </button>
                                {% elif metric_name == 'form_fields' %}
                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#formFieldsModal">
                                        <i data-feather="list" class="me-1"></i>Ver Campos
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <!-- Last Update (Brazilian time) -->
                        <div class="text-center mt-3 pt-2 border-top">
                            <small class="text-muted">
                                Última atualização: 
                                {% if metric_points %}
                                    {{ format_brazilian_time(metric_points[0].timestamp) }}
                                {% else %}
                                    Nunca
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center text-muted py-5">
        <i data-feather="bar-chart" size="64"></i>
        <h4 class="mt-3">Nenhum Dado Disponível</h4>
        <p>Os dados do dashboard estão sendo processados. Verifique novamente mais tarde ou entre em contato com o administrador.</p>
        <button onclick="location.reload()" class="btn btn-primary">
            <i data-feather="refresh-cw"></i> Atualizar
        </button>
    </div>
{% endif %}

<!-- Satisfaction Modal -->
<div class="modal fade" id="satisfactionModal" tabindex="-1" aria-labelledby="satisfactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="satisfactionModalLabel">
                    <i data-feather="star"></i> Pesquisas de Satisfação Recentes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for metric_name, metric_points in metrics_data.items() %}
                    {% if metric_name == 'satisfaction_scores' and metric_points %}
                        {% set satisfaction_data = metric_points[0].data %}
                        {% if satisfaction_data.get('recent_surveys') %}
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>Resumo</h6>
                                    <p><strong>Média:</strong> {{ satisfaction_data.get('average', 0) }}/5.0</p>
                                    <p><strong>Total de respostas:</strong> {{ satisfaction_data.get('count', 0) }}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Distribuição</h6>
                                    {% for score, count in satisfaction_data.get('breakdown', {}).items() %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ score }} ⭐:</span>
                                            <strong>{{ count }} ({{ "%.1f"|format((count / satisfaction_data.get('count', 1)) * 100) }}%)</strong>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <h6>Pesquisas Recentes</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Nota</th>
                                            <th>Comentário</th>
                                            <th>Operador</th>
                                            <th>Data</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for survey in satisfaction_data.get('recent_surveys', []) %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if survey.score >= 4 else ('warning' if survey.score == 3 else 'danger') }}">
                                                        {{ survey.score }}/5
                                                    </span>
                                                </td>
                                                <td>{{ survey.comment or '-' }}</td>
                                                <td>{{ survey.agent }}</td>
                                                <td>{{ survey.date[:10] }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhuma pesquisa de satisfação disponível no período selecionado.</p>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Exportar Relatório</button>
            </div>
        </div>
    </div>
</div>

<!-- Resolution Time Modal (for Inbox) -->
<div class="modal fade" id="resolutionTimeModal" tabindex="-1" aria-labelledby="resolutionTimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resolutionTimeModalLabel">
                    <i data-feather="clock" class="me-2"></i>Detalhes do Tempo de Resolução
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for metric_name, metric_points in metrics_data.items() %}
                    {% if metric_name == 'average_resolution_time' and metric_points %}
                        {% set resolution_data = metric_points[0].data %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Resumo</h6>
                                <p><strong>Tempo médio:</strong> {{ "%.1f"|format(resolution_data.get('average_hours', 0)) }} horas</p>
                                <p><strong>Total de tickets analisados:</strong> {{ resolution_data.get('recent_tickets', [])|length }}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Distribuição por Tempo</h6>
                                {% for time_range, count in resolution_data.get('breakdown', {}).items() %}
                                    <div class="d-flex justify-content-between">
                                        <span>{{ time_range }}:</span>
                                        <strong>{{ count }} tickets</strong>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if resolution_data.get('recent_tickets') %}
                            <h6>Últimos Tickets Analisados</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Assunto</th>
                                            <th>Tipo (Scope)</th>
                                            <th>Estado</th>
                                            <th>Operador</th>
                                            <th>Tempo Resolução</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ticket in resolution_data.get('recent_tickets', []) %}
                                            <tr>
                                                <td>#{{ ticket.number }}</td>
                                                <td>{{ ticket.subject }}</td>
                                                <td><span class="badge bg-info">{{ ticket.scope }}</span></td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if 'Closed' in ticket.state else ('warning' if 'Open' in ticket.state else 'secondary') }}">
                                                        {{ ticket.state.replace('TicketState', '') }}
                                                    </span>
                                                </td>
                                                <td>{{ ticket.operator }}</td>
                                                <td>
                                                    <span class="text-{{ 'success' if ticket.resolution_hours < 4 else ('warning' if ticket.resolution_hours < 24 else 'danger') }}">
                                                        {{ "%.1f"|format(ticket.resolution_hours) }}h
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Exportar Relatório</button>
            </div>
        </div>
    </div>
</div>

<!-- Form Fields Modal (for Inbox) -->
<div class="modal fade" id="formFieldsModal" tabindex="-1" aria-labelledby="formFieldsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formFieldsModalLabel">
                    <i data-feather="list" class="me-2"></i>Campos Personalizados dos Tickets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for metric_name, metric_points in metrics_data.items() %}
                    {% if metric_name == 'form_fields' and metric_points %}
                        {% set form_data = metric_points[0].data %}
                        {% if form_data %}
                            <div class="row">
                                {% for field_name, field_info in form_data.items() %}
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">{{ field_info.label }}</h6>
                                                <small class="text-muted">Campo: {{ field_name }}</small>
                                            </div>
                                            <div class="card-body">
                                                {% for value, count in field_info.get('values', {}).items() %}
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <span class="badge bg-outline-primary">{{ value }}</span>
                                                        <strong>{{ count }} tickets</strong>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhum campo personalizado encontrado nos tickets.</p>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Cross Filter Modal (for Inbox) -->
<div class="modal fade" id="crossFilterModal" tabindex="-1" aria-labelledby="crossFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crossFilterModalLabel">
                    <i data-feather="filter" class="me-2"></i>Análise de Cruzamentos - Form Fields
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for metric_name, metric_points in metrics_data.items() %}
                    {% if metric_name == 'cross_filters' and metric_points %}
                        {% set cross_data = metric_points[0].data %}
                        {% if cross_data %}
                            {% if cross_data.get('_metadata') %}
                                <div class="alert alert-success mb-4">
                                    <h6><i data-feather="info" class="me-2"></i>Sistema Dinâmico Ativo</h6>
                                    <p class="mb-2"><strong>Campos específicos:</strong> {{ cross_data._metadata.available_fields }} encontrados</p>
                                    <p class="mb-0"><strong>Cruzamentos válidos:</strong> {{ cross_data._metadata.valid_combinations }} combinações</p>
                                </div>
                            {% endif %}
                            
                            <div class="row">
                                {% for cross_name, cross_info in cross_data.items() %}
                                    {% if cross_name != '_metadata' %}
                                        <div class="col-md-6 mb-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0">{{ cross_info.get('display_name', cross_name) }}</h6>
                                                    <small class="text-muted">{{ cross_name }}</small>
                                                </div>
                                                <div class="card-body">
                                                    {% if cross_info.get('combinations') %}
                                                        {% for combination, count in cross_info.combinations.items() %}
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <span class="text-sm">{{ combination }}</span>
                                                                <span class="badge bg-info">{{ count }} tickets</span>
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <p class="text-muted">Nenhuma combinação encontrada</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <div class="alert alert-info">
                                <strong>Sistema Dinâmico:</strong> Campos detectados automaticamente para este cliente. 
                                Diferentes clientes terão diferentes combinações baseadas em seus dados únicos.
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <p class="mb-0">Nenhum cruzamento disponível. É necessário ter pelo menos 2 campos com dados.</p>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Exportar Análise</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Scripts -->
<script>
{% for metric_name, metric_points in metrics_data.items() %}
(function() {
    const ctx = document.getElementById('chart-{{ loop.index }}').getContext('2d');
    
    // Prepare chart data
    let labels = [];
    let values = [];
    let chartType = 'line';
    let chartColor = 'rgb(75, 192, 192)';
    
    {% if metric_points %}
        // Get historical data if available
        {% if metric_points|length > 1 %}
            {% for point in metric_points|reverse %}
                labels.push('{{ point.timestamp.strftime('%d/%m') }}');
                values.push({{ point.value or 0 }});
            {% endfor %}
        {% else %}
            // If only one data point, show breakdown if available
            {% set point = metric_points[0] %}
            {% if point.data and metric_name in ['chats_by_department', 'chats_by_operator', 'tickets_by_operator', 'hsm_by_template'] %}
                chartType = 'doughnut';
                {% for key, value in point.data.items() %}
                    {% if key not in ['period', 'unit', 'daily_breakdown', 'breakdown', 'recent_surveys', 'count', 'average', 'hourly_breakdown'] %}
                        labels.push('{{ key }}');
                        values.push({{ value }});
                    {% endif %}
                {% endfor %}
            {% elif point.data and metric_name == 'total_chats' and point.data.get('daily_breakdown') %}
                chartType = 'line';
                {% for day, count in point.data.get('daily_breakdown', {}).items() %}
                    labels.push('{{ day }}');
                    values.push({{ count }});
                {% endfor %}
            {% elif point.data and metric_name == 'queue_time' and point.data.get('hourly_breakdown') %}
                chartType = 'bar';
                {% for hour, time in point.data.get('hourly_breakdown', {}).items() %}
                    labels.push('{{ hour }}');
                    values.push({{ time / 60 }});  // Convert to minutes
                {% endfor %}
            {% else %}
                // Single value - show as bar chart
                chartType = 'bar';
                labels = ['{{ metric_name.replace("_", " ").title() }}'];
                values = [{{ point.value or 0 }}];
            {% endif %}
        {% endif %}
    {% endif %}
    
    // Set chart color based on metric type
    const metricName = '{{ metric_name }}';
    if (metricName.includes('rate') || metricName.includes('compliance')) {
        chartColor = 'rgb(255, 99, 132)';
    } else if (metricName.includes('time') || metricName.includes('duration')) {
        chartColor = 'rgb(255, 206, 86)';
    } else if (metricName.includes('total') || metricName.includes('count')) {
        chartColor = 'rgb(54, 162, 235)';
    }
    
    new Chart(ctx, {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: '{{ get_metric_display_name(metric_name) }}',
                data: values,
                borderColor: chartColor,
                backgroundColor: chartType === 'doughnut' ? 
                    values.map((_, i) => `hsl(${i * 360 / values.length}, 70%, 60%)`) :
                    chartColor + '40',
                borderWidth: 2,
                fill: chartType === 'line',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 800
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: chartType === 'doughnut',
                    position: 'bottom'
                }
            },
            scales: chartType !== 'doughnut' ? {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            } : {}
        }
    });
})();
{% endfor %}

function refreshDashboard() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('Por favor selecione as datas');
        return;
    }
    
    // Show loading indicator
    const cards = document.querySelectorAll('.card-body');
    cards.forEach(card => {
        const spinner = document.createElement('div');
        spinner.className = 'text-center py-3';
        spinner.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        card.appendChild(spinner);
    });
    
    // Reload page with new date range
    window.location.href = `{{ url_for('client.view_dashboard', dashboard_id=dashboard.id) }}?start_date=${startDate}&end_date=${endDate}`;
}
</script>
{% endblock %}