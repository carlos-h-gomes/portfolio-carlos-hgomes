{% extends "base.html" %}

{% block title %}Criador de Dashboard Manual - {{ client.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Criador de Dashboard Manual</h2>
                <div>
                    <span class="badge bg-info me-2">Cliente: {{ client.name }}</span>
                    <a href="{{ url_for('admin.client_dashboards', client_id=client.id) }}" class="btn btn-outline-secondary">
                        <i data-feather="arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Configuração do Dashboard</h5>
                </div>
                <div class="card-body">
                    <form id="dashboardForm">
                        <div class="mb-3">
                            <label for="dashboardName" class="form-label">Nome do Dashboard</label>
                            <input type="text" class="form-control" id="dashboardName" required>
                        </div>

                        <div class="mb-3">
                            <label for="dateRange" class="form-label">Período para Preview</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="date" class="form-control" id="startDate" value="{{ start_date }}">
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control" id="endDate" value="{{ end_date }}">
                                </div>
                            </div>
                        </div>

                        <hr>

                        <h6>Adicionar Widget</h6>
                        
                        <div class="mb-3">
                            <label for="eventType" class="form-label">Tipo de Evento</label>
                            <select class="form-select" id="eventType" onchange="updateAvailableFields()">
                                <option value="all">Todos os Eventos</option>
                                {% for event in available_fields.event_types %}
                                <option value="{{ event.name }}">{{ event.label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="fieldPath" class="form-label">Campo de Dados</label>
                            <select class="form-select" id="fieldPath">
                                <option value="">Selecione um campo...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="widgetType" class="form-label">Tipo de Widget</label>
                            <select class="form-select" id="widgetType">
                                <option value="count">Contador</option>
                                <option value="chart">Gráfico</option>
                                <option value="table">Tabela</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="widgetName" class="form-label">Nome do Widget</label>
                            <input type="text" class="form-control" id="widgetName" placeholder="Ex: Total de Chats">
                        </div>

                        <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="previewData()">
                            <i data-feather="eye"></i> Preview dos Dados
                        </button>

                        <button type="button" class="btn btn-success w-100 mb-2" onclick="addWidget()">
                            <i data-feather="plus"></i> Adicionar Widget
                        </button>
                        
                        <a href="{{ url_for('manual_dashboard.json_spreadsheet_viewer', client_id=client.id) }}" class="btn btn-info w-100 mb-3">
                            <i data-feather="table"></i> Visualizar Dados em Planilha
                        </a>

                        <hr>

                        <button type="button" class="btn btn-primary w-100" onclick="createDashboard()" id="createBtn" disabled>
                            <i data-feather="save"></i> Criar Dashboard
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-md-8">
            <!-- Data Preview -->
            <div class="card mb-3" id="previewCard" style="display: none;">
                <div class="card-header">
                    <h5 class="card-title mb-0">Preview dos Dados</h5>
                </div>
                <div class="card-body">
                    <div id="previewContent"></div>
                </div>
            </div>

            <!-- Widgets List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Widgets do Dashboard</h5>
                </div>
                <div class="card-body">
                    <div id="widgetsList">
                        <p class="text-muted text-center">Nenhum widget adicionado ainda. Use o painel lateral para adicionar widgets.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Available Fields Data -->
<script>
const availableFields = {{ available_fields | tojson }};
const clientId = {{ client.id }};
let dashboardWidgets = [];

function updateAvailableFields() {
    const eventType = document.getElementById('eventType').value;
    const fieldSelect = document.getElementById('fieldPath');
    
    // Clear existing options
    fieldSelect.innerHTML = '<option value="">Selecione um campo...</option>';
    
    let fields = [];
    
    if (eventType === 'all' || eventType === 'DT.Chat') {
        fields = fields.concat(availableFields.chat_fields);
    }
    if (eventType === 'all' || eventType === 'Hi.Bot') {
        fields = fields.concat(availableFields.bot_fields);
    }
    if (eventType === 'all' || eventType === 'Hi.Whatsapp.HSM') {
        fields = fields.concat(availableFields.hsm_fields);
    }
    if (eventType === 'all' || eventType === 'Inbox') {
        fields = fields.concat(availableFields.inbox_fields);
    }
    
    // Add options
    fields.forEach(field => {
        const option = document.createElement('option');
        option.value = field.path;
        option.textContent = field.label;
        fieldSelect.appendChild(option);
    });
}

function previewData() {
    const eventType = document.getElementById('eventType').value;
    const fieldPath = document.getElementById('fieldPath').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!fieldPath) {
        alert('Selecione um campo para preview');
        return;
    }
    
    const params = new URLSearchParams({
        event_type: eventType,
        field_path: fieldPath,
        start_date: startDate,
        end_date: endDate
    });
    
    // Show loading indicator
    const previewCard = document.getElementById('previewCard');
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div><p>Buscando dados da API...</p></div>';
    previewCard.style.display = 'block';
    
    fetch(`/manual-dashboard/api/preview-data/${clientId}?${params}`)
        .then(response => {
            if (response.status === 429) {
                return response.json().then(data => {
                    throw new Error(data.error + ' (API temporariamente limitada)');
                });
            }
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                previewContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                if (data.loading) {
                    previewContent.innerHTML += '<div class="alert alert-info">Os dados estão sendo processados. Tente novamente em alguns minutos.</div>';
                }
                return;
            }
            
            displayPreview(data);
        })
        .catch(error => {
            console.error('Error:', error);
            previewContent.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
        });
}

function displayPreview(data) {
    const previewCard = document.getElementById('previewCard');
    const previewContent = document.getElementById('previewContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>Resumo</h6>
                <p><strong>Total de itens:</strong> ${data.total_items}</p>
                <p><strong>Dados do campo:</strong> ${data.field_data ? data.field_data.length : 0} valores</p>
            </div>
            <div class="col-md-6">
                <h6>Amostra dos Dados</h6>
                <div class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                    <pre>${JSON.stringify(data.preview ? data.preview.slice(0, 10) : [], null, 2)}</pre>
                </div>
            </div>
        </div>
    `;
    
    previewContent.innerHTML = html;
    previewCard.style.display = 'block';
}

function addWidget() {
    const eventType = document.getElementById('eventType').value;
    const fieldPath = document.getElementById('fieldPath').value;
    const widgetType = document.getElementById('widgetType').value;
    const widgetName = document.getElementById('widgetName').value;
    
    if (!fieldPath || !widgetName) {
        alert('Preencha o campo de dados e o nome do widget');
        return;
    }
    
    const widget = {
        id: Date.now(),
        name: widgetName,
        type: widgetType,
        field_path: fieldPath,
        event_type_filter: eventType === 'all' ? null : eventType
    };
    
    dashboardWidgets.push(widget);
    updateWidgetsList();
    
    // Clear form
    document.getElementById('widgetName').value = '';
    document.getElementById('fieldPath').value = '';
    
    // Enable create button
    document.getElementById('createBtn').disabled = false;
}

function updateWidgetsList() {
    const widgetsList = document.getElementById('widgetsList');
    
    if (dashboardWidgets.length === 0) {
        widgetsList.innerHTML = '<p class="text-muted text-center">Nenhum widget adicionado ainda. Use o painel lateral para adicionar widgets.</p>';
        return;
    }
    
    let html = '<div class="row">';
    
    dashboardWidgets.forEach(widget => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">${widget.name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Tipo: ${widget.type}<br>
                                        Campo: ${widget.field_path}<br>
                                        ${widget.event_type_filter ? `Filtro: ${widget.event_type_filter}` : 'Todos os eventos'}
                                    </small>
                                </p>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeWidget(${widget.id})">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    widgetsList.innerHTML = html;
    
    // Re-initialize feather icons
    feather.replace();
}

function removeWidget(widgetId) {
    dashboardWidgets = dashboardWidgets.filter(w => w.id !== widgetId);
    updateWidgetsList();
    
    if (dashboardWidgets.length === 0) {
        document.getElementById('createBtn').disabled = true;
    }
}

function createDashboard() {
    const dashboardName = document.getElementById('dashboardName').value;
    
    if (!dashboardName || dashboardWidgets.length === 0) {
        alert('Preencha o nome do dashboard e adicione pelo menos um widget');
        return;
    }
    
    const config = {
        name: dashboardName,
        widgets: dashboardWidgets,
        created_at: new Date().toISOString()
    };
    
    fetch(`/manual-dashboard/api/create-custom-dashboard/${clientId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Erro: ' + data.error);
            return;
        }
        
        alert('Dashboard criado com sucesso!');
        window.location.href = `/admin/client/${clientId}/dashboards`;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao criar dashboard');
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateAvailableFields();
});
</script>
{% endblock %}