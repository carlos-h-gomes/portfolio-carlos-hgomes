<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Planos de A√ß√£o - {{ cliente.nome }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function abrirModalCriarPlano() {
      document.getElementById('modalPlano').classList.remove('hidden');
      document.getElementById('checklistContainer').innerHTML = '';
      adicionarChecklist();
    }
    function fecharModalCriarPlano() {
      document.getElementById('modalPlano').classList.add('hidden');
    }
    function adicionarChecklist() {
      const container = document.getElementById('checklistContainer');
      const index = container.children.length;

      const html = `
        <div class="border p-3 rounded bg-gray-50 space-y-2">
          <input type="text" name="itens[${index}][tarefa]" placeholder="Descri√ß√£o da tarefa" required class="w-full border px-3 py-2 rounded text-sm">
          <input type="text" name="itens[${index}][responsavel]" placeholder="Respons√°vel" required class="w-full border px-3 py-2 rounded text-sm">
          <input type="date" name="itens[${index}][prazo]" required class="w-full border px-3 py-2 rounded text-sm">
          <select name="itens[${index}][status]" class="w-full border px-3 py-2 rounded text-sm">
            <option value="Pendente">Pendente</option>
            <option value="Em Andamento">Em Andamento</option>
            <option value="Conclu√≠do">Conclu√≠do</option>
          </select>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  {% include 'navbar.html' %}

  <div class="max-w-4xl mx-auto">
    <a href="/clientes"
       class="inline-block mb-4 text-blue-600 hover:underline text-sm">&larr; Voltar para clientes</a>

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">
        Planos de A√ß√£o - {{ cliente.nome }}{% if cliente.id_operacao %} <span class="text-sm text-gray-500">#{{ cliente.id_operacao }}</span>{% endif %}
      </h1>

      <div class="flex gap-2">
        <a href="#" onclick="abrirModalCriarPlano()"
           class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">+ Novo Plano</a>
        <a href="/planos/exportar?cliente_id={{ cliente.id }}"
           class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">üì• Exportar</a>
      </div>
    </div>

    {% if planos %}
      <div class="space-y-6">
        {% for plano in planos %}
          <div class="bg-white shadow rounded-lg p-4 border border-gray-200 cursor-pointer hover:bg-gray-50"
           ondblclick="window.location.href='/planos/{{ plano.id_plano }}'">

            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold">
                {{ plano.titulo or "Plano de A√ß√£o" }}
              </h2>
              <span class="text-xs text-gray-500 italic">
                Criado em: {{ plano.criado_em[:16].replace('T', ' √†s ') }}
              </span>
            </div>

            <p class="text-sm text-gray-700 my-2 whitespace-pre-line">{{ plano.descricao }}</p>

            <h3 class="text-sm font-semibold text-gray-600">Checklist:</h3>
            <ul class="mt-2 space-y-2">
              {% for item in plano.itens %}
                <li class="bg-gray-50 border rounded px-3 py-2 text-sm">
                  <div class="flex justify-between">
                    <span class="font-medium">{{ item.tarefa }}</span>

<div class="text-xs space-y-1">
  <select onchange="abrirModalResultado('{{ plano.cliente_id if plano.cliente_id else cliente.id }}', '{{ plano.id_plano }}', '{{ loop.index0 }}', this.value)"
          class="px-2 py-1 rounded-full text-xs border
          {% if item.status == 'Conclu√≠do' %}bg-green-200 text-green-800
          {% elif item.status == 'Em Andamento' %}bg-blue-200 text-blue-800
          {% else %}bg-yellow-100 text-yellow-800{% endif %}">
    <option value="Pendente" {% if item.status == 'Pendente' %}selected{% endif %}>Pendente</option>
    <option value="Em Andamento" {% if item.status == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
    <option value="Conclu√≠do" {% if item.status == 'Conclu√≠do' %}selected{% endif %}>Conclu√≠do</option>
  </select>
</div>

                  </div>
                  <p class="text-gray-600 text-sm">Respons√°vel: {{ item.responsavel }}</p>
                  <p class="text-gray-500 text-sm">Prazo: {{ item.prazo }}</p>
                  {% if item.resultado %}
                    <p class="text-sm text-blue-700 mt-1"><strong>Resultado:</strong> {{ item.resultado }}</p>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>

            {% if is_admin %}
              <form method="POST" action="/planos/excluir" onsubmit="return confirm('Deseja excluir este plano?')" class="text-right mt-2">
                <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                <input type="hidden" name="id_plano" value="{{ plano.id_plano }}">
                <button type="submit" class="text-red-600 text-sm hover:underline">üóëÔ∏è Excluir plano</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      {% if total_paginas > 1 %}
        <div class="flex justify-center mt-8 gap-4">
          {% if pagina_atual > 1 %}
            <a href="?page={{ pagina_atual - 1 }}"
               class="px-4 py-2 bg-gray-200 rounded text-sm hover:bg-gray-300">‚Üê Anterior</a>
          {% endif %}

          <span class="text-sm text-gray-600">P√°gina {{ pagina_atual }} de {{ total_paginas }}</span>

          {% if pagina_atual < total_paginas %}
            <a href="?page={{ pagina_atual + 1 }}"
               class="px-4 py-2 bg-gray-200 rounded text-sm hover:bg-gray-300">Pr√≥xima ‚Üí</a>
          {% endif %}
        </div>
      {% endif %}

    {% else %}
      <p class="text-sm text-gray-600">Nenhum plano de a√ß√£o registrado ainda para este cliente.</p>
    {% endif %}
  </div>

  <!-- Modal Criar Plano -->
  <div id="modalPlano" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl relative max-h-[90vh] overflow-auto">
      <h2 class="text-xl font-bold mb-4">Novo Plano de A√ß√£o</h2>
      <form id="formPlano" method="POST" action="/planos/salvar">
        <input type="hidden" name="cliente_id" value="{{ cliente.id }}">

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo do Plano</label>
          <input type="text" name="titulo" required class="w-full border px-3 py-2 rounded text-sm">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o geral</label>
          <textarea name="descricao" rows="2" required class="w-full border px-3 py-2 rounded text-sm"></textarea>
        </div>

        <div id="checklistContainer" class="space-y-4 mb-4"></div>
        <button type="button" onclick="adicionarChecklist()" class="text-sm text-blue-600 font-semibold mb-4">
          + Adicionar item ao checklist
        </button>

        <div class="flex justify-end gap-4 mt-6">
          <button type="button" onclick="fecharModalCriarPlano()" class="text-sm text-gray-600 hover:underline">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Salvar Plano</button>
        </div>
      </form>
    </div>
  </div>

<!-- Modal Resultado -->
<div id="modalResultado" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow w-full max-w-md relative">
    <h2 class="text-lg font-bold mb-4">Informe o resultado</h2>
    <form method="POST" action="/planos/atualizar_status">
      <input type="hidden" name="cliente_id" id="modal_cliente_id">
      <input type="hidden" name="id_plano" id="modal_id_plano">
      <input type="hidden" name="item_index" id="modal_item_index">
      <input type="hidden" name="status" value="Conclu√≠do">
      <textarea name="resultado" required placeholder="Descreva o resultado"
                class="w-full border px-3 py-2 rounded text-sm mb-4"></textarea>
      <div class="flex justify-end gap-4">
        <button type="button" onclick="fecharModalResultado()" class="text-sm text-gray-600 hover:underline">Cancelar</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModalResultado(clienteId, planoId, index, status) {
    if (status === "Conclu√≠do") {
      document.getElementById('modalResultado').classList.remove('hidden');
      document.getElementById('modalResultado').classList.add('flex');
      document.getElementById('modal_cliente_id').value = clienteId;
      document.getElementById('modal_id_plano').value = planoId;
      document.getElementById('modal_item_index').value = index;
    } else {
      // Enviar diretamente o formul√°rio para mudar para Pendente
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/planos/atualizar_status';

      const inputs = [
        ['cliente_id', clienteId],
        ['id_plano', planoId],
        ['item_index', index],
        ['status', status]
      ];

      inputs.forEach(([name, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
    }
  }

  function fecharModalResultado() {
    document.getElementById('modalResultado').classList.add('hidden');
    document.getElementById('modalResultado').classList.remove('flex');
  }
</script>

</body>
</html>
