<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Kanban de Planos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gray-100 p-6 min-h-screen">
  {% include 'navbar.html' %}

  <h1 class="text-2xl font-bold mb-6">ğŸ—‚ï¸ Kanban de Planos de AÃ§Ã£o</h1>
  âš ï¸ Essa visualizaÃ§Ã£o estÃ¡ em desenvolvimento, problemas podem ocorrer âš ï¸
  <br>

  <div class="flex gap-4 mb-6">
    <a href="/planos" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">ğŸ“‹ Lista</a>
    <a href="/planos/kanban" class="bg-yellow-500 text-white px-4 py-2 rounded text-sm hover:bg-yellow-600">ğŸ—‚ï¸ Kanban</a>
    <a href="/planos/timeline" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">ğŸ“… Linha do Tempo</a>
  </div>

  <div class="flex gap-6 overflow-x-auto">
    <!-- Coluna Pendentes -->
    <div class="flex-1 bg-white p-4 rounded shadow min-w-[300px]">
      <h2 class="text-lg font-semibold text-yellow-600 mb-4">Pendente</h2>
      <div id="pendente" class="space-y-4 min-h-[300px]">
        {% for card in pendentes %}
          <div class="bg-yellow-100 p-3 rounded shadow cursor-move"
               data-id="{{ card.id_full }}"
               data-cliente="{{ card.cliente_id }}"
               data-tarefa="{{ card.tarefa }}"
              ondblclick="window.location.href='/planos/{{ card.id_plano }}'">
            <p class="text-xs text-gray-600 mb-1">{{ card.cliente_nome }}</p>
            <p class="font-semibold text-sm">{{ card.plano_titulo }}</p>
            <p class="text-sm mt-1 tarefa">ğŸ“‹ {{ card.tarefa }}</p>
            <p class="text-xs text-gray-700 mt-1">ğŸ‘¤ {{ card.responsavel }}</p>
            <p class="text-xs text-gray-700">ğŸ“… {{ card.prazo }}</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Coluna Em Andamento -->
    <div class="flex-1 bg-white p-4 rounded shadow min-w-[300px]">
      <h2 class="text-lg font-semibold text-blue-600 mb-4">Em Andamento</h2>
      <div id="andamento" class="space-y-4 min-h-[300px]">
        {% for card in andamento %}
          <div class="bg-blue-100 p-3 rounded shadow cursor-move"
               data-id="{{ card.id_full }}"
               data-cliente="{{ card.cliente_id }}"
               data-tarefa="{{ card.tarefa }}"
            ondblclick="window.location.href='/planos/{{ card.id_plano }}'">
            <p class="text-xs text-gray-600 mb-1">{{ card.cliente_nome }}</p>
            <p class="font-semibold text-sm">{{ card.plano_titulo }}</p>
            <p class="text-sm mt-1 tarefa">ğŸ“‹ {{ card.tarefa }}</p>
            <p class="text-xs text-gray-700 mt-1">ğŸ‘¤ {{ card.responsavel }}</p>
            <p class="text-xs text-gray-700">ğŸ“… {{ card.prazo }}</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Coluna ConcluÃ­do -->
    <div class="flex-1 bg-white p-4 rounded shadow min-w-[300px]">
      <h2 class="text-lg font-semibold text-green-600 mb-4">ConcluÃ­do</h2>
      <div id="concluido" class="space-y-4 min-h-[300px]">
        {% for card in concluidos %}
          <div class="bg-green-100 p-3 rounded shadow cursor-move"
               data-id="{{ card.id_full }}"
               data-cliente="{{ card.cliente_id }}"
               data-tarefa="{{ card.tarefa }}"
            ondblclick="window.location.href='/planos/{{ card.id_plano }}'">
            <p class="text-xs text-gray-600 mb-1">{{ card.cliente_nome }}</p>
            <p class="font-semibold text-sm">{{ card.plano_titulo }}</p>
            <p class="text-sm mt-1 tarefa">ğŸ“‹ {{ card.tarefa }}</p>
            <p class="text-xs text-gray-700 mt-1">ğŸ‘¤ {{ card.responsavel }}</p>
            <p class="text-xs text-gray-700">ğŸ“… {{ card.prazo }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div id="modalResultado" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow w-full max-w-md relative">
      <h2 class="text-lg font-bold mb-4">Informe o Resultado</h2>
      <textarea id="resultadoTexto" placeholder="Descreva o resultado..." class="w-full border px-3 py-2 rounded text-sm mb-4" rows="4"></textarea>
      <div class="flex justify-end gap-4">
        <button type="button" onclick="fecharModalResultado()" class="text-sm text-gray-600 hover:underline">Cancelar</button>
        <button type="button" onclick="confirmarResultado()" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">Salvar Resultado</button>
      </div>
    </div>
  </div>

  <script>
    function enviarAtualizacao(card, novoStatus, resultado = null) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/planos/atualizar_status_kanban';

      const params = {
        cliente_id: card.getAttribute('data-cliente'),
        id_plano: card.getAttribute('data-id'),
        tarefa: card.getAttribute('data-tarefa'),
        status: novoStatus
      };

      if (resultado) {
        params.resultado = resultado;
      }

      for (const key in params) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = params[key];
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit();
    }

    function configurarSortable(idColuna, statusDestino) {
      new Sortable(document.getElementById(idColuna), {
        group: 'kanban',
        animation: 150,
        onAdd: function (evt) {
          const card = evt.item;
          if (statusDestino === 'ConcluÃ­do') {
            abrirModalResultado(card);
          } else {
            enviarAtualizacao(card, statusDestino);
          }
        }
      });
    }

    configurarSortable('pendente', 'Pendente');
    configurarSortable('andamento', 'Em Andamento');
    configurarSortable('concluido', 'ConcluÃ­do');

    let cardAtual = null;
    let novoStatusAtual = null;

    function abrirModalResultado(card) {
      cardAtual = card;
      novoStatusAtual = "ConcluÃ­do";
      document.getElementById('resultadoTexto').value = "";
      document.getElementById('modalResultado').classList.remove('hidden');
      document.getElementById('modalResultado').classList.add('flex');
    }

    function fecharModalResultado() {
      document.getElementById('modalResultado').classList.add('hidden');
      document.getElementById('modalResultado').classList.remove('flex');
      cardAtual = null;
      novoStatusAtual = null;
    }

    function confirmarResultado() {
      const resultado = document.getElementById('resultadoTexto').value.trim();
      if (!resultado) {
        alert("Por favor, preencha o resultado!");
        return;
      }
      enviarAtualizacao(cardAtual, novoStatusAtual, resultado);
      fecharModalResultado();
    }
  </script>

</body>
</html>